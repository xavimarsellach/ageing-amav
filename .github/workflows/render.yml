name: Render Quarto pipeline

on:
  push:
    branches: [ main ]
    paths:
      - "analysis/**"
      - "scripts/**"
      - "data/**"
      - "environment.yml"
      - "CITATION.cff"
      - "README.md"
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # R setup
      # -----------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(
            c("knitr","rmarkdown",
              "readxl","ggplot2","reshape2","scales",
              "writexl","dplyr","tidyr"),
            repos = "https://cloud.r-project.org"
          )'

      # -----------------------------
      # Python setup
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.2.3 numpy==2.1.2 openpyxl xlsxwriter matplotlib statsmodels

      # -----------------------------
      # Install Quarto
      # -----------------------------
      - name: Install Quarto
        run: |
          QUARTO_VERSION=1.5.57
          wget https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
          tar -xzf quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
          echo "$PWD/quarto-${QUARTO_VERSION}/bin" >> $GITHUB_PATH

      # -----------------------------
      # Render ONLY HTML (no PDF)
      # -----------------------------
      - name: Render Quarto document (HTML only)
        run: |
          quarto --version
          quarto render analysis/Ageing_is_not_Just-ageing_AMAV_Data_Process_Pipeline.qmd --to html

      # -----------------------------
      # Upload artefacts
      # -----------------------------
      - name: Upload rendered artefacts
        uses: actions/upload-artifact@v4
        with:
          name: rendered-quarto
          path: |
            analysis/*.html
            output/**